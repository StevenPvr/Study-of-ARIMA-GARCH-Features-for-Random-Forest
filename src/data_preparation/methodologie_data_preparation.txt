# PrÃ©paration des DonnÃ©es S&P 500

**Objectif** : Transformer les donnÃ©es brutes en datasets prÃªts pour l'entraÃ®nement ML.

## ğŸ—ï¸ Deux Pipelines Distincts

### ğŸ“ˆ Pipeline SÃ©ries Temporelles (ARIMA/GARCH)
**Input** : `weighted_log_returns.parquet` (rendements pondÃ©rÃ©s du marchÃ©)  
**Output** : Train/test splits chronologiques simples

**Ã‰tapes** :
1. **Split temporel** : Division train/test respectant l'ordre chronologique
2. **Validation** : CohÃ©rence temporelle et complÃ©tude des donnÃ©es

### ğŸ¤– Pipeline ML SupervisÃ© (LightGBM/Random Forest)
**Input** : `dataset_filtered.parquet` (donnÃ©es OHLCV par ticker)  
**Output** : Features + targets par ticker avec splits temporels

**Ã‰tapes** :
1. **Features techniques** : Log returns, volatilitÃ© rÃ©alisÃ©e, volume
2. **Split par ticker** : Chaque ticker divisÃ© temporellement (train â‰¤ date_split, test > date_split)
3. **Validation** : Absence de fuite de donnÃ©es, robustesse statistique

## ğŸ”§ Architecture Modulaire

- `main.py` : CLI orchestrant les deux pipelines
- `timeseriessplit.py` : Gestion splits sÃ©ries temporelles
- `ticker_preparation.py` : PrÃ©paration donnÃ©es individuelles tickers
- `computations.py` : Calculs features techniques
- `data_preparation.py` : Wrappers et constantes par dÃ©faut

## âœ… Garanties ClÃ©s

- **ğŸ›¡ï¸ Anti-fuite** : Aucune donnÃ©e future utilisÃ©e (voir section ci-dessous)
- **ğŸ“Š Robustesse** : Gestion NaN, valeurs extrÃªmes, validation types
- **âš¡ Performance** : Calculs vectorisÃ©s pandas, groupby/rolling optimisÃ©s
- **ğŸ§ª Tests** : Couverture complÃ¨te calculs + intÃ©gration

## ğŸ”’ StratÃ©gie Anti-Leakage Critique

### ProblÃ¨me des FenÃªtres Roulantes

Les features basÃ©es sur des fenÃªtres roulantes (ex: volatilitÃ© sur 5 jours) peuvent crÃ©er une **fuite de donnÃ©es** si calculÃ©es aprÃ¨s le split train/test :

```
Split date: 2022-07-26

Test observation 2022-07-27: fenÃªtre [2022-07-23 Ã  2022-07-27] âŒ CONTAMINATION
  â†’ Utilise des donnÃ©es du train set (2022-07-23, 24, 25, 26)

Test observation 2022-08-02: fenÃªtre [2022-07-27 Ã  2022-08-02] âœ… PROPRE
  â†’ Utilise uniquement des donnÃ©es du test set
```

### Solution ImplÃ©mentÃ©e

1. **Calcul des features AVANT le split** : Toutes les features (log_return, log_volatility) sont calculÃ©es sur l'ensemble complet des donnÃ©es
2. **Split temporel** : Application de la date de split globale Ã  tous les tickers
3. **Suppression des observations contaminÃ©es** : Les premiÃ¨res `(window_size - 1)` observations du test set sont supprimÃ©es pour chaque ticker
   - Avec `window_size = 5` : suppression des 4 premiÃ¨res observations test
   - Garantit que toutes les observations test restantes ont des features calculÃ©es uniquement Ã  partir de donnÃ©es du test set

### Trade-offs DocumentÃ©s

**Split Global vs. Split par Ticker** :
- âœ… **Split global** (implÃ©mentÃ©) : Garantit sÃ©paration temporelle stricte entre tous les tickers, simplifie la validation
- âš ï¸ **InconvÃ©nient** : Tickers avec diffÃ©rentes dates d'introduction peuvent avoir des ratios train/test inÃ©gaux
- âš ï¸ **Biais de survie potentiel** : Tickers retirÃ©s du S&P 500 avant la pÃ©riode test n'ont pas de donnÃ©es test

**Approches alternatives considÃ©rÃ©es** :
- Split par ticker (ratios Ã©gaux mais possibilitÃ© de chevauchement temporel)
- Filtrage minimum d'observations par split (implÃ©mentÃ© en aval)

### Validation

Des tests automatisÃ©s (`tests/data_preparation/test_data_leakage_validation.py`) vÃ©rifient :
- Absence de chevauchement temporel train/test
- Suppression correcte des observations contaminÃ©es
- IntÃ©gritÃ© des features aprÃ¨s split
- Transparence de la perte de donnÃ©es (logging dÃ©taillÃ©)

## ğŸ“ Outputs

- **SÃ©ries** : `weighted_log_returns_split.parquet`
- **ML** : DonnÃ©es tickers enrichies (features calculÃ©es in-place)
